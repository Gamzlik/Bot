

        # === NEW: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" ===
        buy_stats_row = await db_fetchone("SELECT SUM(count) FROM buy_stats")
        buy_total = buy_stats_row[0] or 0
        text += f"\n\nüí∞ –ö–Ω–æ–ø–∫–∞ '–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç' –Ω–∞–∂–∞—Ç–∞ –≤—Å–µ–≥–æ: {buy_total} —Ä–∞–∑"
        # =================================================

        await call.message.answer(text, reply_markup=back_admin_kb())

    # –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞/—Ñ–∞–π–ª–∞ –æ—Ç –∞–¥–º–∏–Ω–∞
    elif action in ("broadcast", "upload_tanks", "upload_mir", "add_ref", "remove_ref", "clear_tanks", "clear_mir"):
        _pending_action[ADMIN_ID] = action
        prompts = {
            "broadcast": "üì£ –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ (–±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º).",
            "upload_tanks": "üì• –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–∞–π–ª .txt –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –¥–ª—è Tanks Blitz (–∫–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏).",
            "upload_mir": "üì• –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–∞–π–ª .txt –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –¥–ª—è Mir Tankov (–∫–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏).",
            "add_ref": "‚ûï –í–≤–µ–¥–∏—Ç–µ username (–±–µ–∑ @) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü—Ä–∏–º–µ—Ä: user123 2",
            "remove_ref": "‚ûñ –í–≤–µ–¥–∏—Ç–µ username (–±–µ–∑ @) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü—Ä–∏–º–µ—Ä: user123 1",
            "clear_tanks": "‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—á–∏—Å—Ç–∫—É –±–∞–∑—ã Tanks Blitz –æ—Ç–≤–µ—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–ª—é–±–æ–µ).",
            "clear_mir": "‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—á–∏—Å—Ç–∫—É –±–∞–∑—ã Mir Tankov –æ—Ç–≤–µ—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–ª—é–±–æ–µ)."
        }
        await call.message.answer(prompts[action], reply_markup=back_admin_kb())

    elif action == "clear":  # –Ω–∞ –±—É–¥—É—â–µ–µ
        await call.message.answer("OK")

    elif action == "back":
        await call.message.answer("üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=admin_kb())

    await call.answer()

# ---------------- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π/—Ñ–∞–π–ª–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∞ (—Ä–µ–∂–∏–º—ã) ----------------
@dp.message()
async def handle_admin_inputs(message: types.Message):
    # –æ–±–Ω–æ–≤–ª—è–µ–º username –≤ –±–∞–∑–µ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    try:
        if message.from_user:
            await db_execute("INSERT OR IGNORE INTO users(user_id, username) VALUES (?, ?)", (message.from_user.id, message.from_user.username))
            await db_execute("UPDATE users SET username = ? WHERE user_id = ?", (message.from_user.username, message.from_user.id))
    except Exception:
        pass

    # –∞–¥–º–∏–Ω—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    if message.from_user.id != ADMIN_ID:
        return

    action = _pending_action.get(ADMIN_ID)
    if not action:
        return

    # ---------------- BROADCAST ----------------
    if action == "broadcast":
        text = message.text or ""
        if not text:
            await message.answer("‚ùå –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—Ç–º–µ–Ω–µ–Ω–æ.")
            _pending_action.pop(ADMIN_ID, None)
            return
        users = await db_fetchall("SELECT user_id FROM users")
        sent = 0
        for (uid,) in users:
            try:
                await bot.send_message(uid, text)
                sent += 1
            except Exception:
                continue
        await message.answer(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}")
        _pending_action.pop(ADMIN_ID, None)
        return

    # ---------------- UPLOAD (—Ñ–∞–π–ª –∏–ª–∏ —Ç–µ–∫—Å—Ç) ----------------
    if action in ("upload_tanks", "upload_mir"):
        # —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–º —Ñ–∞–π–ª .txt
        table = "accounts_tanks" if action == "upload_tanks" else "accounts_mir"
        count_added = 0

        # –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî —Å–∫–∞—á–∏–≤–∞–µ–º –∏ —á–∏—Ç–∞–µ–º
        if message.document:
            # –ø—Ä–∏–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ .txt –∏–ª–∏ .csv
            if message.document:
                fname = message.document.file_name or ""
                if not (fname.endswith(".txt") or fname.endswith(".csv")):
                    await message.answer("‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .txt –∏–ª–∏ .csv —Ñ–∞–π–ª—ã.")
                    return

                dst = os.path.join(DOWNLOADS_DIR, f"{message.message_id}_{fname}")

                # --- –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ ---
                file = await bot.get_file(message.document.file_id)
                await bot.download_file(file.file_path, dst)
                # ------------------------------------------

                with open(dst, "r", encoding="utf-8", errors="ignore") as f:
                    lines = [ln.strip() for ln in f if ln.strip()]
        else:
            # –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, —Å—á–∏—Ç–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏
            lines = (message.text or "").strip().splitlines()

        for ln in lines:
            if ":" not in ln:
                # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ –±–µ–∑ ":" ‚Äî –Ω–æ –ø–æ —É—Å–ª–æ–≤–∏—é –æ–∂–∏–¥–∞–µ—Ç—Å—è email:pass
                # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
                continue
            await db_execute(f"INSERT INTO {table} (data) VALUES (?)", (ln.strip(),))
            count_added += 1

        await message.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ {table}: {count_added}")
        _pending_action.pop(ADMIN_ID, None)
        return

    # ---------------- ADD / REMOVE REF ----------------
    if action in ("add_ref", "remove_ref"):
        parts = (message.text or "").strip().split()
        if len(parts) != 2 or not parts[1].isdigit():
            await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: user123 2")
            return
        username, amount = parts[0].lstrip("@"), int(parts[1])
        user_row = await db_fetchone("SELECT user_id, invited FROM users WHERE username = ?", (username,))
        if not user_row:
            await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
            _pending_action.pop(ADMIN_ID, None)
            return
        target_user_id, invited = user_row
        if action == "add_ref":
            invited_new = invited + amount
        else:
            invited_new = max(0, invited - amount)
        await db_execute("UPDATE users SET invited = ? WHERE user_id = ?", (invited_new, target_user_id))
        await message.answer(f"‚úÖ –ì–æ—Ç–æ–≤–æ. –¢–µ–∫—É—â–∏–µ –∑–∞—á—Ç—ë–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã —É @{username}: {invited_new}")
        _pending_action.pop(ADMIN_ID, None)
        return

    # ---------------- CLEAR DATABASES ----------------
    if action in ("clear_tanks", "clear_mir"):
        table = "accounts_tanks" if action == "clear_tanks" else "accounts_mir"
        await db_execute(f"DELETE FROM {table}")
        await message.answer(f"‚úÖ –ë–∞–∑–∞ {table} –æ—á–∏—â–µ–Ω–∞.")
        _pending_action.pop(ADMIN_ID, None)
        return

# ---------------- FALLBACK (–ø—Ä–æ—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) ----------------
@dp.message()
async def handle_messages(message: types.Message):
    # –æ–±–Ω–æ–≤–ª—è–µ–º username –≤ –±–∞–∑–µ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    try:
        if message.from_user:
            await db_execute(
                "INSERT OR IGNORE INTO users(user_id, username) VALUES (?, ?)",
                (message.from_user.id, message.from_user.username)
            )
            await db_execute(
                "UPDATE users SET username = ? WHERE user_id = ?",
                (message.from_user.username, message.from_user.id)
            )
    except Exception:
        pass

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
    if message.from_user.id == ADMIN_ID:
        action = _pending_action.get(ADMIN_ID)
        if action:
            # –≤—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Å—å –∫–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π (broadcast, upload, add/remove ref, clear)
            ...
            return

    # Fallback –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    return

# ... –≤—Å–µ —Ç–≤–æ–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (start, referral, admin, upload –∏ —Ç.–¥.) ...

# ---------------- FALLBACK / –ê–ù–¢–ò–°–ü–ê–ú ----------------
import time

_last_message_time: dict[int, float] = {}
SPAM_INTERVAL = 3  # —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

@dp.message(lambda m: True)
async def safe_fallback(message: types.Message):
    try:
        user_id = message.from_user.id
        now = time.time()

        last_time = _last_message_time.get(user_id, 0)
        if now - last_time < SPAM_INTERVAL:
            try:
                await message.delete()
            except Exception:
                pass
            return

        _last_message_time[user_id] = now
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ "–ø—Ä–æ—à–ª–æ –º–∏–º–æ"
        return

    except Exception:
        return

# ---------------- START BOT ----------------
async def main():
    await init_db()
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
