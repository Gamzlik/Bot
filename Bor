# bot_admin_menu_full.py
import asyncio
import os
import aiosqlite
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import (
    InlineKeyboardMarkup, InlineKeyboardButton,
    KeyboardButton, ReplyKeyboardMarkup, InputFile
)
from aiogram.enums import ParseMode
from aiogram.client.bot import DefaultBotProperties

# ---------------- –ê–ù–¢–ò–°–ü–ê–ú ----------------
import time
from functools import wraps

ANTI_SPAM_DELAY = 1  # —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –Ω–∞–∂–∞—Ç–∏—è–º–∏
_last_click: dict[int, float] = {}

def anti_spam_handler(handler):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞ –∫–Ω–æ–ø–æ–∫ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π."""
    @wraps(handler)
    async def wrapper(event, *args, **kwargs):
        user_id = event.from_user.id
        now = time.time()
        last = _last_click.get(user_id, 0)
        if now - last < ANTI_SPAM_DELAY:
            # –ï—Å–ª–∏ callback
            if isinstance(event, types.CallbackQuery):
                try:
                    await event.answer("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –Ω–∞–∂–∏–º–∞–µ—Ç–µ –∫–Ω–æ–ø–∫—É. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.", show_alert=True)
                except Exception:
                    pass
            # –ï—Å–ª–∏ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            elif isinstance(event, types.Message):
                try:
                    await event.answer("‚ö†Ô∏è –°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ –Ω–∞–∂–∏–º–∞–µ—Ç–µ –∫–Ω–æ–ø–∫—É. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.")
                except Exception:
                    pass
            return
        _last_click[user_id] = now
        return await handler(event, *args, **kwargs)
    return wrapper

# ---------------- CONFIG ----------------
TOKEN = "7972973668:AAGA_AQpO6aiioesWvrj6usiV0iyII_i8vE"
ADMIN_ID = 6544413140  # <- –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π ID
CHANNELS = ["@GAMZLIK_WOT", "@TANKS_BLITZ_GAMZLIK", "@shopwotacc"]
DB_PATH = "bot.db"
DOWNLOADS_DIR = "downloads"
os.makedirs(DOWNLOADS_DIR, exist_ok=True)

# ---------------- BOT / DISPATCHER ----------------
bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

# –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω-–æ–ø–µ—Ä–∞—Ü–∏–π (admin_id -> action)
_pending_action: dict[int, str] = {}


# ---------------- DATABASE (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è) ----------------
async def init_db():
    async with aiosqlite.connect(DB_PATH) as db:
        # users: invited = —Ç–µ–∫—É—â–∏–µ "–∑–∞—á—Ç—ë–Ω–Ω—ã–µ" —Ä–µ—Ñ–µ—Ä–∞–ª—ã (–¥–ª—è –≤—ã–¥–∞—á–∏),
        # total_referred = –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ —Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–∏–≤–ª—ë–∫ (–∏ –∫–æ—Ç–æ—Ä—ã–µ –∑–∞—Ç–µ–º –±—ã–ª–∏ –∑–∞—á—Ç–µ–Ω—ã),
        # claimed_tanks/mir = –±—ã–ª–∏ –ª–∏ –≤—ã–¥–∞–Ω—ã –∞–∫–∫–∞—É–Ω—Ç—ã (0/1)
        await db.execute("""
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            invited INTEGER DEFAULT 0,
            total_referred INTEGER DEFAULT 0,
            claimed_tanks INTEGER DEFAULT 0,
            claimed_mir INTEGER DEFAULT 0,
            referrer_id INTEGER DEFAULT NULL
        );
        """)
        await db.execute("""
        CREATE TABLE IF NOT EXISTS accounts_tanks (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            data TEXT
        );
        """)
        await db.execute("""
        CREATE TABLE IF NOT EXISTS accounts_mir (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            data TEXT
        );
        """)

        # === NEW: –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" ===
        await db.execute("""
        CREATE TABLE IF NOT EXISTS buy_stats (
            user_id INTEGER PRIMARY KEY,
            count INTEGER DEFAULT 0
        );
        """)
        # ============================================================

        await db.commit()


# ---------------- DB HELPERS ----------------
async def db_execute(query: str, params: tuple = ()):
    async with aiosqlite.connect(DB_PATH) as db:
        cur = await db.execute(query, params)
        await db.commit()
        return cur


async def db_fetchone(query: str, params: tuple = ()):
    async with aiosqlite.connect(DB_PATH) as db:
        cur = await db.execute(query, params)
        return await cur.fetchone()


async def db_fetchall(query: str, params: tuple = ()):
    async with aiosqlite.connect(DB_PATH) as db:
        cur = await db.execute(query, params)
        return await cur.fetchall()


# ---------------- KEYBOARDS ----------------
def subscription_buttons():
    buttons = [
        [InlineKeyboardButton(text=f"üìå –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ {ch.lstrip('@')}", url=f"https://t.me/{ch.lstrip('@')}")]
        for ch in CHANNELS
    ]
    buttons.append([InlineKeyboardButton(text="‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", callback_data="check_sub")])
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def main_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üéÅ –ü–æ–ª—É—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç")],
            [KeyboardButton(text="üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞")]
        ],
        resize_keyboard=True
    )


# === NEW: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–æ–π "–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" ===
def main_keyboard_with_buy():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üéÅ –ü–æ–ª—É—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç"), KeyboardButton(text="üí∞ –ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç")],
            [KeyboardButton(text="üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞")]
        ],
        resize_keyboard=True
    )


# =====================================================

def choose_game_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="Tanks Blitz", callback_data="choose_game:tanks")],
        [InlineKeyboardButton(text="Mir Tankov", callback_data="choose_game:mir")]
    ])


def admin_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin:stats")],
        [InlineKeyboardButton(text="üì§ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="admin:broadcast")],
        [InlineKeyboardButton(text="üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å Tanks Blitz", callback_data="admin:upload_tanks")],
        [InlineKeyboardButton(text="üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å Mir Tankov", callback_data="admin:upload_mir")],
        [InlineKeyboardButton(text="‚ùå –û—á–∏—Å—Ç–∏—Ç—å Tanks Blitz", callback_data="admin:clear_tanks")],
        [InlineKeyboardButton(text="‚ùå –û—á–∏—Å—Ç–∏—Ç—å Mir Tankov", callback_data="admin:clear_mir")],
        [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤", callback_data="admin:add_ref")],
        [InlineKeyboardButton(text="‚ûñ –£–±—Ä–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤", callback_data="admin:remove_ref")],
        [InlineKeyboardButton(text="üîô –ó–∞–∫—Ä—ã—Ç—å", callback_data="admin:back")]
    ])


def back_admin_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin:back")]
    ])


# ---------------- HELPERS ----------------
async def is_subscribed(user_id: int) -> bool:
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã (–±–æ—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á–∏—Ç–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
    for ch in CHANNELS:
        try:
            member = await bot.get_chat_member(ch, user_id)
            if member.status in ("left", "kicked"):
                return False
        except Exception:
            return False
    return True


# ---------------- /start (—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞) ----------------
@dp.message(Command("start"))
@anti_spam_handler
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username or None
    await db_execute("INSERT OR IGNORE INTO users(user_id, username) VALUES (?, ?)", (user_id, username))
    await db_execute("UPDATE users SET username = ? WHERE user_id = ?", (username, user_id))

    # –ï—Å–ª–∏ –ø—Ä–∏—à—ë–ª –ø–æ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–µ: /start <refid>
    parts = (message.text or "").split()
    if len(parts) > 1 and parts[1].isdigit():
        ref = int(parts[1])
        if ref != user_id:
            row = await db_fetchone("SELECT 1 FROM users WHERE user_id = ?", (ref,))
            if row:
                await db_execute("UPDATE users SET referrer_id = ? WHERE user_id = ?", (ref, user_id))

    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º ‚Äî –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à–∏ –∫–∞–Ω–∞–ª—ã –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª.",
        reply_markup=subscription_buttons()
    )

    # === NEW: –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω—é —Å –∫–Ω–æ–ø–∫–æ–π "–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" ===
    # –í /start –∫–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" –ø–æ–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤ callback_check_sub
    # await message.answer("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!", reply_markup=main_keyboard_with_buy())

# ---------------- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ ----------------
@dp.callback_query(lambda c: c.data == "check_sub")
@anti_spam_handler
async def callback_check_sub(call: types.CallbackQuery):
    user_id = call.from_user.id
    username = call.from_user.username or None
    await db_execute("UPDATE users SET username = ? WHERE user_id = ?", (username, user_id))

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã
    if not await is_subscribed(user_id):
        await call.answer("‚ùå –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã.", show_alert=True)
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—à—ë–ª –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ, –∑–∞—Å—á–∏—Ç–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    row = await db_fetchone("SELECT referrer_id FROM users WHERE user_id = ?", (user_id,))
    if row and row[0]:
        referrer_id = row[0]

        # –ó–∞—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞
        await db_execute(
            "UPDATE users SET invited = invited + 1, total_referred = total_referred + 1 WHERE user_id = ?",
            (referrer_id,))
        # –£–±–∏—Ä–∞–µ–º referrer_id, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–µ –∑–∞—Å—á–∏—Ç—ã–≤–∞–ª–æ—Å—å
        await db_execute("UPDATE users SET referrer_id = NULL WHERE user_id = ?", (user_id,))

        # –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ 3 —Ä–µ—Ñ–µ—Ä–∞–ª–∞, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏ —Å–Ω–∏–º–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–µ–Ω–∏—è
        invited_row = await db_fetchone("SELECT invited FROM users WHERE user_id = ?", (referrer_id,))
        if invited_row and invited_row[0] >= 3:
            await db_execute(
                "UPDATE users SET invited = invited - 3, claimed_tanks = 0, claimed_mir = 0 WHERE user_id = ?",
                (referrer_id,))
            try:
                await bot.send_message(referrer_id,
                    "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø—Ä–∏–≤–µ–ª–∏ 3 –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–∞ ‚Äî –≤–∞–º –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç.")
            except Exception:
                pass

    # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞
    await call.message.answer("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!", reply_markup=main_keyboard_with_buy())
    await call.answer()

# ---------------- –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ ----------------
@dp.message(lambda m: m.text == "üéÅ –ü–æ–ª—É—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç")
@anti_spam_handler
async def msg_get_account(message: types.Message):
    user_id = message.from_user.id
    if not await is_subscribed(user_id):
        await message.answer("‚ùå –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã.", reply_markup=subscription_buttons())
        return
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ –∏–≥—Ä—É:", reply_markup=choose_game_kb())


from aiogram.enums import ParseMode  # —É–±–µ–¥–∏—Å—å, —á—Ç–æ –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å

@dp.callback_query(lambda c: c.data and c.data.startswith("choose_game:"))
@anti_spam_handler
async def callback_choose_game(call: types.CallbackQuery):
    user_id = call.from_user.id
    _, game = call.data.split(":")  # 'tanks' –∏–ª–∏ 'mir'

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫–∫–∞—É–Ω—Ç–æ–≤
    row = await db_fetchone("SELECT claimed_tanks, claimed_mir, invited FROM users WHERE user_id = ?", (user_id,))
    claimed_tanks = claimed_mir = invited = 0
    if row:
        claimed_tanks, claimed_mir, invited = row

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
    if claimed_tanks == 0 and claimed_mir == 0:
        # –ú–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
        first_free = True
    else:
        first_free = False

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
    if not first_free:
        if invited < 3:
            await call.message.answer(
                f"‚ö†Ô∏è –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç, –Ω—É–∂–Ω–æ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å 3 –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –¥—Ä—É–≥–∞.\n"
                f"–°–µ–π—á–∞—Å —É –≤–∞—Å: {invited}/3"
            )
            await call.answer()
            return
        else:
            # –°–ø–∏—Å—ã–≤–∞–µ–º 3 —Ä–µ—Ñ–µ—Ä–∞–ª–∞
            await db_execute("UPDATE users SET invited = invited - 3 WHERE user_id = ?", (user_id,))

    # –í—ã–¥–∞—ë–º –∞–∫–∫–∞—É–Ω—Ç
    table = "accounts_tanks" if game == "tanks" else "accounts_mir"
    acc_row = await db_fetchone(f"SELECT id, data FROM {table} ORDER BY id LIMIT 1")
    if not acc_row:
        await call.message.answer("‚ùóÔ∏è–ê–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–π –∏–≥—Ä—ã —Å–µ–π—á–∞—Å –Ω–µ—Ç")
        await call.answer()
        return

    acc_id, acc_data = acc_row
    await db_execute(f"DELETE FROM {table} WHERE id = ?", (acc_id,))

    if game == "tanks":
        await db_execute("UPDATE users SET claimed_tanks = 1 WHERE user_id = ?", (user_id,))
    else:
        await db_execute("UPDATE users SET claimed_mir = 1 WHERE user_id = ?", (user_id,))

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–∫–∫–∞—É–Ω—Ç
    await call.message.answer(
        f"üéÅ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è {'Tanks Blitz' if game == 'tanks' else 'Mir Tankov'}:\n\n<code>{acc_data}</code>",
        parse_mode=ParseMode.HTML
    )
    await call.answer()


# === NEW: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" ===
@dp.message(lambda m: m.text == "üí∞ –ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç")
@anti_spam_handler
async def msg_buy_account(message: types.Message):
    user_id = message.from_user.id

    # ---------------- –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É ----------------
    row = await db_fetchone("SELECT count FROM buy_stats WHERE user_id = ?", (user_id,))
    if row:
        await db_execute("UPDATE buy_stats SET count = count + 1 WHERE user_id = ?", (user_id,))
    else:
        await db_execute("INSERT INTO buy_stats(user_id, count) VALUES (?, ?)", (user_id, 1))

    # ---------------- –ü–µ—Ä–µ–∫–∏–¥—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥—Ä—É–≥–æ–π –±–æ—Ç ----------------
    bot_link = "https://t.me/shopWotBot"  # <- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    await message.answer(f"üí∞ –ß—Ç–æ–±—ã –∫—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç, –ø–µ—Ä–µ–π–¥–∏—Ç–µ —Å—é–¥–∞:\n{bot_link}")


# ====================================================

# ---------------- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–ø–æ–∫–∞–∑) ----------------
@dp.message(lambda m: m.text == "üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞")
@anti_spam_handler
async def msg_referral(message: types.Message):
    user_id = message.from_user.id
    me = await bot.get_me()
    link = f"https://t.me/{me.username}?start={user_id}"
    row = await db_fetchone("SELECT invited, total_referred FROM users WHERE user_id = ?", (user_id,))
    invited = row[0] if row else 0
    total_referred = row[1] if row else 0
    await message.answer(
        f"üë• <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n\n"
        f"üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:\n{link}\n\n"
        f"üë§ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–Ω–∞ —Ä—É–∫–∞—Ö): {invited}\n"
        f"üìà –í—Å–µ–≥–æ –±—ã–ª–æ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–æ (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ): {total_referred}\n\n"
        f"üíé –ó–∞ –∫–∞–∂–¥—ã–µ 3 —Ä–µ—Ñ–µ—Ä–∞–ª–∞ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç!\n"
        f"‚ö†Ô∏è –†–µ—Ñ–µ—Ä–∞–ª –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—à–µ—Ç—Å—è –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã."
    )


# ---------------- /admin (–æ—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å) ----------------
@dp.message(Command("admin"))
async def cmd_admin(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")
        return
    await message.answer("üîß <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b>", reply_markup=admin_kb())


# ---------------- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏–π –≤ –∞–¥–º–∏–Ω-–º–µ–Ω—é ----------------
@dp.callback_query(lambda c: c.data and c.data.startswith("admin:"))
async def admin_callback(call: types.CallbackQuery):
    user_id = call.from_user.id
    if user_id != ADMIN_ID:
        await call.answer("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.", show_alert=True)
        return

    action = call.data.split(":")[1]

    if action == "stats":
        users_total_row = await db_fetchone("SELECT COUNT(*) FROM users")
        users_total = users_total_row[0] if users_total_row else 0

        tanks_left_row = await db_fetchone("SELECT COUNT(*) FROM accounts_tanks")
        tanks_left = tanks_left_row[0] if tanks_left_row else 0

        mir_left_row = await db_fetchone("SELECT COUNT(*) FROM accounts_mir")
        mir_left = mir_left_row[0] if mir_left_row else 0

        given_tanks_row = await db_fetchone("SELECT SUM(claimed_tanks) FROM users")
        given_mir_row = await db_fetchone("SELECT SUM(claimed_mir) FROM users")
        given_tanks = given_tanks_row[0] or 0
        given_mir = given_mir_row[0] or 0
        given_total = given_tanks + given_mir

        total_referred_row = await db_fetchone("SELECT SUM(total_referred) FROM users")
        total_referred = total_referred_row[0] or 0

        text = (
            f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞</b>\n\n"
            f"üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {users_total}\n\n"
            f"üéÆ –û—Å—Ç–∞–ª–æ—Å—å –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Tanks Blitz: {tanks_left}\n"
            f"üéÆ –û—Å—Ç–∞–ª–æ—Å—å –∞–∫–∫–∞—É–Ω—Ç–æ–≤ Mir Tankov: {mir_left}\n\n"
            f"‚úÖ –í—Å–µ–≥–æ –≤—ã–¥–∞–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤: {given_total} (Tanks: {given_tanks}, Mir: {given_mir})\n"
            f"üìà –í—Å–µ–≥–æ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ): {total_referred}"
        )

        # === NEW: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç" ===
        buy_stats_row = await db_fetchone("SELECT SUM(count) FROM buy_stats")
        buy_total = buy_stats_row[0] or 0
        text += f"\n\nüí∞ –ö–Ω–æ–ø–∫–∞ '–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç' –Ω–∞–∂–∞—Ç–∞ –≤—Å–µ–≥–æ: {buy_total} —Ä–∞–∑"
        # =================================================

        await call.message.answer(text, reply_markup=back_admin_kb())

    # –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: –ø–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞/—Ñ–∞–π–ª–∞ –æ—Ç –∞–¥–º–∏–Ω–∞
    elif action in ("broadcast", "upload_tanks", "upload_mir", "add_ref", "remove_ref", "clear_tanks", "clear_mir"):
        _pending_action[ADMIN_ID] = action
        prompts = {
            "broadcast": "üì£ –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ (–±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º).",
            "upload_tanks": "üì• –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–∞–π–ª .txt –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –¥–ª—è Tanks Blitz (–∫–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏).",
            "upload_mir": "üì• –ü—Ä–∏—à–ª–∏—Ç–µ —Ñ–∞–π–ª .txt –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏ –¥–ª—è Mir Tankov (–∫–∞–∂–¥—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏).",
            "add_ref": "‚ûï –í–≤–µ–¥–∏—Ç–µ username (–±–µ–∑ @) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü—Ä–∏–º–µ—Ä: user123 2",
            "remove_ref": "‚ûñ –í–≤–µ–¥–∏—Ç–µ username (–±–µ–∑ @) –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü—Ä–∏–º–µ—Ä: user123 1",
            "clear_tanks": "‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—á–∏—Å—Ç–∫—É –±–∞–∑—ã Tanks Blitz –æ—Ç–≤–µ—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–ª—é–±–æ–µ).",
            "clear_mir": "‚ùó –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—á–∏—Å—Ç–∫—É –±–∞–∑—ã Mir Tankov –æ—Ç–≤–µ—Ç–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º (–ª—é–±–æ–µ)."
        }
        await call.message.answer(prompts[action], reply_markup=back_admin_kb())

    elif action == "clear":  # –Ω–∞ –±—É–¥—É—â–µ–µ
        await call.message.answer("OK")

    elif action == "back":
        await call.message.answer("üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=admin_kb())

    await call.answer()

# ---------------- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π/—Ñ–∞–π–ª–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∞ (—Ä–µ–∂–∏–º—ã) ----------------
@dp.message()
async def handle_admin_inputs(message: types.Message):
    # –æ–±–Ω–æ–≤–ª—è–µ–º username –≤ –±–∞–∑–µ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    try:
        if message.from_user:
            await db_execute("INSERT OR IGNORE INTO users(user_id, username) VALUES (?, ?)", (message.from_user.id, message.from_user.username))
            await db_execute("UPDATE users SET username = ? WHERE user_id = ?", (message.from_user.username, message.from_user.id))
    except Exception:
        pass

    # –∞–¥–º–∏–Ω—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    if message.from_user.id != ADMIN_ID:
        return

    action = _pending_action.get(ADMIN_ID)
    if not action:
        return

    # ---------------- BROADCAST ----------------
    if action == "broadcast":
        text = message.text or ""
        if not text:
            await message.answer("‚ùå –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û—Ç–º–µ–Ω–µ–Ω–æ.")
            _pending_action.pop(ADMIN_ID, None)
            return
        users = await db_fetchall("SELECT user_id FROM users")
        sent = 0
        for (uid,) in users:
            try:
                await bot.send_message(uid, text)
                sent += 1
            except Exception:
                continue
        await message.answer(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}")
        _pending_action.pop(ADMIN_ID, None)
        return

    # ---------------- UPLOAD (—Ñ–∞–π–ª –∏–ª–∏ —Ç–µ–∫—Å—Ç) ----------------
    if action in ("upload_tanks", "upload_mir"):
        # —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–º —Ñ–∞–π–ª .txt
        table = "accounts_tanks" if action == "upload_tanks" else "accounts_mir"
        count_added = 0

        # –µ—Å–ª–∏ —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî —Å–∫–∞—á–∏–≤–∞–µ–º –∏ —á–∏—Ç–∞–µ–º
        if message.document:
            # –ø—Ä–∏–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ .txt –∏–ª–∏ .csv
            if message.document:
                fname = message.document.file_name or ""
                if not (fname.endswith(".txt") or fname.endswith(".csv")):
                    await message.answer("‚ùå –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ .txt –∏–ª–∏ .csv —Ñ–∞–π–ª—ã.")
                    return

                dst = os.path.join(DOWNLOADS_DIR, f"{message.message_id}_{fname}")

                # --- –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞ ---
                file = await bot.get_file(message.document.file_id)
                await bot.download_file(file.file_path, dst)
                # ------------------------------------------

                with open(dst, "r", encoding="utf-8", errors="ignore") as f:
                    lines = [ln.strip() for ln in f if ln.strip()]
        else:
            # –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç, —Å—á–∏—Ç–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏
            lines = (message.text or "").strip().splitlines()

        for ln in lines:
            if ":" not in ln:
                # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ –±–µ–∑ ":" ‚Äî –Ω–æ –ø–æ —É—Å–ª–æ–≤–∏—é –æ–∂–∏–¥–∞–µ—Ç—Å—è email:pass
                # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
                continue
            await db_execute(f"INSERT INTO {table} (data) VALUES (?)", (ln.strip(),))
            count_added += 1

        await message.answer(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ {table}: {count_added}")
        _pending_action.pop(ADMIN_ID, None)
        return

    # ---------------- ADD / REMOVE REF ----------------
    if action in ("add_ref", "remove_ref"):
        parts = (message.text or "").strip().split()
        if len(parts) != 2 or not parts[1].isdigit():
            await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: user123 2")
            return
        username, amount = parts[0].lstrip("@"), int(parts[1])
        user_row = await db_fetchone("SELECT user_id, invited FROM users WHERE username = ?", (username,))
        if not user_row:
            await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.")
            _pending_action.pop(ADMIN_ID, None)
            return
        target_user_id, invited = user_row
        if action == "add_ref":
            invited_new = invited + amount
        else:
            invited_new = max(0, invited - amount)
        await db_execute("UPDATE users SET invited = ? WHERE user_id = ?", (invited_new, target_user_id))
        await message.answer(f"‚úÖ –ì–æ—Ç–æ–≤–æ. –¢–µ–∫—É—â–∏–µ –∑–∞—á—Ç—ë–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã —É @{username}: {invited_new}")
        _pending_action.pop(ADMIN_ID, None)
        return

    # ---------------- CLEAR DATABASES ----------------
    if action in ("clear_tanks", "clear_mir"):
        table = "accounts_tanks" if action == "clear_tanks" else "accounts_mir"
        await db_execute(f"DELETE FROM {table}")
        await message.answer(f"‚úÖ –ë–∞–∑–∞ {table} –æ—á–∏—â–µ–Ω–∞.")
        _pending_action.pop(ADMIN_ID, None)
        return

# ---------------- FALLBACK (–ø—Ä–æ—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) ----------------
@dp.message()
async def handle_messages(message: types.Message):
    # –æ–±–Ω–æ–≤–ª—è–µ–º username –≤ –±–∞–∑–µ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∏—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    try:
        if message.from_user:
            await db_execute(
                "INSERT OR IGNORE INTO users(user_id, username) VALUES (?, ?)",
                (message.from_user.id, message.from_user.username)
            )
            await db_execute(
                "UPDATE users SET username = ? WHERE user_id = ?",
                (message.from_user.username, message.from_user.id)
            )
    except Exception:
        pass

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
    if message.from_user.id == ADMIN_ID:
        action = _pending_action.get(ADMIN_ID)
        if action:
            # –≤—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Å—å –∫–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π (broadcast, upload, add/remove ref, clear)
            ...
            return

    # Fallback –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    return

# ... –≤—Å–µ —Ç–≤–æ–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (start, referral, admin, upload –∏ —Ç.–¥.) ...

# ---------------- FALLBACK / –ê–ù–¢–ò–°–ü–ê–ú ----------------
import time

_last_message_time: dict[int, float] = {}
SPAM_INTERVAL = 3  # —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

@dp.message(lambda m: True)
async def safe_fallback(message: types.Message):
    try:
        user_id = message.from_user.id
        now = time.time()

        last_time = _last_message_time.get(user_id, 0)
        if now - last_time < SPAM_INTERVAL:
            try:
                await message.delete()
            except Exception:
                pass
            return

        _last_message_time[user_id] = now
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ "–ø—Ä–æ—à–ª–æ –º–∏–º–æ"
        return

    except Exception:
        return

# ---------------- START BOT ----------------
async def main():
    await init_db()
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
